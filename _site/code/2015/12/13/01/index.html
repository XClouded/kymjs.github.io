<!DOCTYPE html>
<html>

  <head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>EventBus源码研读(中)|开源实验室-张涛</title>
	<meta name="description" content="AndroidEventBus 是一款针对Android优化的发布/订阅事件总线。主要功能是替代Intent, Handler, BroadCast 在 Fragment，Activity，Service，线程之间传递消息.优点是开销小，使用方便,可以很大程度上降低它们之间的耦合，使得我们的代码更加简洁，耦...">

	<meta name="keyword" content="Android,EventBus源码研读(中),张涛,开源实验室">
	
	<link rel="canonical" href="http://www.kymjs.com/code/2015/12/13/01">
	<link rel="alternate" type="application/rss+xml" title="开源实验室" href="http://www.kymjs.com/feed.xml" />
	
	<!-- <link rel="stylesheet" href="//css/main.css"> -->

	<link rel="stylesheet" type="text/css" href="http://apps.bdimg.com/libs/bootstrap/3.3.0/css/bootstrap.min.css">
	<!-- <link rel="stylesheet" type="text/css" href="http://apps.bdimg.com/libs/fontawesome/4.2.0/css/font-awesome.min.css"> -->
	<!-- <link rel="stylesheet" type="text/css" href="//static/css/bootstrap.min.css"> -->
	
	<link rel="stylesheet" type="text/css" href="/static/css/index.css">
	
	<!-- <script type="text/javascript" src="//static/js/jquery-1.11.1.min.js"></script>
	<script type="text/javascript" src="//static/js/bootstrap.min.js"></script> -->

	<script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js"></script>
	<script type="text/javascript" src="http://apps.bdimg.com/libs/bootstrap/3.3.0/js/bootstrap.min.js"></script>

	<script type="text/javascript" src="//static/js/index.js"></script>
	
	<link rel="stylesheet" type="text/css" href="http://apps.bdimg.com/libs/highlight.js/8.4/styles/monokai_sublime.min.css">
	<!-- <link rel="stylesheet" type="text/css" href="http://apps.bdimg.com/libs/highlight.js/8.4/styles/railscasts.min.css"> -->
	<!-- <link rel="stylesheet" type="text/css" href="http://apps.bdimg.com/libs/highlight.js/8.4/styles/monokai.min.css"> -->
	<!-- <script type="text/javascript" src="http://apps.bdimg.com/libs/highlight.js/8.4/languages/dos.min.js"></script> -->
	<script type="text/javascript" src="http://apps.bdimg.com/libs/highlight.js/8.4/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>

	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?12d2f5b556fafe71819af97b2ec2c5e8";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>

</head>

 <!--  <body data-spy="scroll" data-target="#myAffix"> -->
  <body>

    <header>

<!-- navbar -->
  <nav class="navbar navbar-inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="//">张涛-开源实验室</a>
      <p class="navbar-text">无论何时，请保持学者的谦逊与宽容</p>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1" align="right">
      <ul class="nav navbar-nav navbar-right">

        <li>
        
        <a href="//column"><span class="glyphicon glyphicon-th-large"></span> 专栏</a></li>

        <li>
        
        <a href="//"><span class="glyphicon glyphicon-th-large"></span> 博客</a></li>
        
        <li>
        
        <a href="//works"><span class="glyphicon glyphicon-play"></span> 作品</a></li>

        <li>
        
        <a href="//about"><span class="glyphicon glyphicon-heart"></span> 关于</a></li>

        <li>
        
        <a href="//donate"><span class="glyphicon glyphicon-heart"></span> 感谢</a></li>

        
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

</header>

    <div id="main" class="container main">
      <div class="row">
  <div id="myArticle" class="col-sm-9">
    <div class="post-area post">
      <header align="center">
        <h1>EventBus源码研读(中)</h1>
        <p>
          <h2>2015-12-13</h2>
          
          
        </p>
      </header>
      <hr>
      <article id="page">
        <h3>摘要</h3>
        本文原创，转载请注明地址：<a href="http://kymjs.com/code/2015/12/13/01">http://kymjs.com/code/2015/12/13/01</a><br>
        <!-- 本博客客户端下载【<a href="http://www.kymjs.com/app">请点击</a>】<br> -->
        EventBus 是一款针对Android优化的发布/订阅事件总线。主要功能是替代Intent, Handler, BroadCast 在 Fragment，Activity，Service，线程之间传递消息.优点是开销小，使用方便,可以很大程度上降低它们之间的耦合，使得我们的代码更加简洁，耦合性更低，提升我们的代码质量。 类似的库还有 Otto ,今天就带大家一起研读 EventBus 的源码.<br><br>
        <ul id="markdown-toc">
  <li><a href="#subscribe">Subscribe流程</a>    <ul>
      <li><a href="#subscribermethod">SubscriberMethod类</a></li>
      <li><a href="#subscribermethodfinder">SubscriberMethodFinder类</a></li>
    </ul>
  </li>
  <li><a href="#subscribe-1">事件的处理与发送subscribe()</a></li>
  <li><a href="#registerposter">Register与Poster工作图</a>    <ul>
      <li><a href="#section">原理图</a></li>
      <li><a href="#section-1">流程图</a></li>
    </ul>
  </li>
</ul>

<p>第一篇 EventBus源码研读(上) <a href="http://kymjs.com/code/2015/12/12/01/">http://kymjs.com/code/2015/12/12/01/</a> <br />
第二篇 EventBus源码研读(中) <a href="http://www.kymjs.com/code/2015/12/13/01/">http://kymjs.com/code/2015/12/13/01/</a>  <br />
第三篇 EventBus源码研读(下) <a href="http://kymjs.com/code/2015/12/16/01/">http://kymjs.com/code/2015/12/16/01/</a>     </p>

<p>在写这篇文章之前，我已经将本文相关的中文注释代码上传到了GitHub：<a href="https://github.com/kymjs/EventBus">https://github.com/kymjs/EventBus</a>   </p>

<h2 id="subscribe">Subscribe流程</h2>
<p>我们继续来看<code>EventBus</code>类，分析完了包含的属性，接下来我们看入口方法<code>register()</code>   </p>

<p>通过查看源码我们发现，所有的register()方法，最后都会直接或者间接的调用register()方法</p>

<div class="highlight"><pre><code class="java"> 
<span class="cm">/**</span>
<span class="cm"> * @param subscriber 订阅者对象</span>
<span class="cm"> * @param sticky     是否粘滞</span>
<span class="cm"> * @param priority   优先级</span>
<span class="cm"> */</span>
<span class="kd">private</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">Object</span> <span class="n">subscriber</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">sticky</span><span class="o">,</span> <span class="kt">int</span> <span class="n">priority</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">SubscriberMethod</span><span class="o">&gt;</span> <span class="n">subscriberMethods</span> <span class="o">=</span> <span class="n">subscriberMethodFinder</span><span class="o">.</span><span class="na">findSubscriberMethods</span>
            <span class="o">(</span><span class="n">subscriber</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">SubscriberMethod</span> <span class="n">subscriberMethod</span> <span class="o">:</span> <span class="n">subscriberMethods</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">subscribe</span><span class="o">(</span><span class="n">subscriber</span><span class="o">,</span> <span class="n">subscriberMethod</span><span class="o">,</span> <span class="n">sticky</span><span class="o">,</span> <span class="n">priority</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<h4 id="subscribermethod">SubscriberMethod类</h4>
<p>出现了一个<code>SubscriberMethod</code>类，看看它是干嘛的：</p>

<p>看字面意思是订阅者方法,看看类中的内容，除了复写的equals()和hashCode()就只有这些了。</p>

<div class="highlight"><pre><code class="java"> 
<span class="kd">final</span> <span class="n">Method</span> <span class="n">method</span><span class="o">;</span> <span class="c1">//方法名</span>
<span class="kd">final</span> <span class="n">ThreadMode</span> <span class="n">threadMode</span><span class="o">;</span> <span class="c1">//工作在哪个线程</span>
<span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">eventType</span><span class="o">;</span> <span class="c1">//参数类型</span>
<span class="cm">/** Used for efficient comparison */</span>
<span class="n">String</span> <span class="n">methodString</span><span class="o">;</span>

<span class="kd">private</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">checkMethodString</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">methodString</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Method.toString has more overhead, just take relevant parts of the method</span>
        <span class="n">StringBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="mi">64</span><span class="o">);</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;#&#39;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;(&#39;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">eventType</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="n">methodString</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p><code>ThreadMode</code>是一个枚举类，是不是应该换成 int 更好呢。
<code>checkMethodString()</code>方法就是为了设置变量 methodString 的值，这里new了一个<code>StringBuilder</code>，然后又调用了<code>toString()</code>返回，是不是应该改成直接<code>new String(format...)</code>更好呢？  <br />
OK，不管那些细节，看到这里就知道，其实这个类也就是一个封装了的方法名而已。  </p>

<p>回到<code>EventBus#register()</code>咱们继续.
噢，又遇到了<code>SubscriberMethodFinder</code>这又是啥，继续去看。  </p>

<h4 id="subscribermethodfinder">SubscriberMethodFinder类</h4>
<p>从字面理解，就是订阅者方法发现者。<br />
回想一下，我们之前用 EventBus 的时候，需要在注册方法传的那个 this 对象里面写一个 <code>onEvent()</code> 方法。没错，<code>SubscriberMethodFinder</code>类就是查看传进去的那个 this 对象里面有没有<code>onEvent()</code>方法的。怎么做到的？当然是反射。而且这个类用了大量的反射去查找类中方法名。    </p>

<p>先看他的变量声明</p>

<div class="highlight"><pre><code class="java"> 
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ON_EVENT_METHOD_NAME</span> <span class="o">=</span> <span class="s">&quot;onEvent&quot;</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * 在较新的类文件，编译器可能会添加方法。那些被称为BRIDGE或SYNTHETIC方法。</span>
<span class="cm"> * EventBus必须忽略两者。有修饰符没有公开，但在Java类文件中有格式定义</span>
<span class="cm"> */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">BRIDGE</span> <span class="o">=</span> <span class="mh">0x40</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">SYNTHETIC</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="o">;</span>
<span class="c1">//需要忽略的修饰符</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MODIFIERS_IGNORE</span> <span class="o">=</span> <span class="n">Modifier</span><span class="o">.</span><span class="na">ABSTRACT</span> <span class="o">|</span> <span class="n">Modifier</span><span class="o">.</span><span class="na">STATIC</span> <span class="o">|</span> <span class="n">BRIDGE</span> <span class="o">|</span>
        <span class="n">SYNTHETIC</span><span class="o">;</span>

<span class="c1">//key:类名,value:该类中需要相应的方法集合</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">SubscriberMethod</span><span class="o">&gt;&gt;</span> <span class="n">methodCache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">SubscriberMethod</span><span class="o">&gt;&gt;();</span>

<span class="c1">//跳过校验方法的类(即通过构造函数传入的集合)</span>
<span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">skipMethodVerificationForClasses</span><span class="o">;</span>
</code></pre></div>

<p>有一句注释  </p>

<blockquote>
  <p>In newer class files, compilers may add methods. Those are called bridge or synthetic methods. EventBus must ignore both. There modifiers are not public but defined in the Java class file format: http://docs.oracle.com/javase/specs/jvms/se7/html/jvms-4.html#jvms-4.6-200-A.1</p>
</blockquote>

<p>翻译过来大概就是说java编译器在编译的时候，会额外添加一些修饰符，然后这些修饰符为了效率应该是被忽略的。</p>

<p>还有一个<code>skipMethodVerificationForClasses</code>，看到注释是需要跳过被校验方法的类，校验方法是什么？看看他是干什么的。<code>findSubscriberMethods()</code>方法有点长，咱们抽一点看。
跳过上面的那些临时变量，从while循环里开始看：</p>

<div class="highlight"><pre><code class="java"> 
<span class="n">Method</span><span class="o">[]</span> <span class="n">methods</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredMethods</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="n">Method</span> <span class="n">method</span> <span class="o">:</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">methodName</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="n">ON_EVENT_METHOD_NAME</span><span class="o">))</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">modifiers</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">();</span><span class="c1">//方法的修饰符</span>
        <span class="c1">//如果是public,且 不是之前定义要忽略的类型</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">modifiers</span> <span class="o">&amp;</span> <span class="n">Modifier</span><span class="o">.</span><span class="na">PUBLIC</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">modifiers</span> <span class="o">&amp;</span> <span class="n">MODIFIERS_IGNORE</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//。。。先不看</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="n">clazz</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">();</span>
</code></pre></div>

<p>首先是反射获取到 clazz 的全部方法 methods。<br />
通过对全部的方法遍历，为了效率首先做一次筛选，只关注我们的以 “onEvent” 开头的方法。(现在知道之前在基础用法中我说：其实命名不一定必须是onEvent()的原因了吧，因为只要是onEvent开头的就可以了。) <br />
忽略private类型的，最后如果是公有，并且不是 java编译器 生成的方法名，那么就是我们要的了。</p>

<p>再来看拿到要的方法后是怎么处理的</p>

<div class="highlight"><pre><code class="java"> 
<span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">parameterTypes</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">();</span>
<span class="c1">//如果只有一个参数</span>
<span class="k">if</span> <span class="o">(</span><span class="n">parameterTypes</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">modifierString</span> <span class="o">=</span> <span class="n">methodName</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">ON_EVENT_METHOD_NAME</span>
            <span class="o">.</span><span class="na">length</span><span class="o">());</span>
    <span class="n">ThreadMode</span> <span class="n">threadMode</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">modifierString</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">threadMode</span> <span class="o">=</span> <span class="n">ThreadMode</span><span class="o">.</span><span class="na">PostThread</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">modifierString</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;MainThread&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">threadMode</span> <span class="o">=</span> <span class="n">ThreadMode</span><span class="o">.</span><span class="na">MainThread</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">modifierString</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;BackgroundThread&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">threadMode</span> <span class="o">=</span> <span class="n">ThreadMode</span><span class="o">.</span><span class="na">BackgroundThread</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">modifierString</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Async&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">threadMode</span> <span class="o">=</span> <span class="n">ThreadMode</span><span class="o">.</span><span class="na">Async</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">skipMethodVerificationForClasses</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">clazz</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">continue</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">EventBusException</span><span class="o">(</span><span class="s">&quot;Illegal onEvent method, check &quot;</span> <span class="o">+</span>
                    <span class="s">&quot;for typos: &quot;</span> <span class="o">+</span> <span class="n">method</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">eventType</span> <span class="o">=</span> <span class="n">parameterTypes</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
    <span class="n">methodKeyBuilder</span><span class="o">.</span><span class="na">setLength</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="n">methodKeyBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">methodName</span><span class="o">);</span>
    <span class="n">methodKeyBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;&gt;&#39;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">eventType</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="n">String</span> <span class="n">methodKey</span> <span class="o">=</span> <span class="n">methodKeyBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">eventTypesFound</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">methodKey</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// 方法名,工作在哪个线程,事件类型</span>
        <span class="n">subscriberMethods</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">SubscriberMethod</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">threadMode</span><span class="o">,</span>
                <span class="n">eventType</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>还是反射，拿到这个方法的全部参数集合，如果是只有一个参数，再去根据不同的方法名赋予不同的线程模式(其实也就是最后响应的方法是工作在哪个线程)。<br />
这里我们看到，其实<code>EventBus</code>不仅仅支持<code>onEvent()</code>的回调，它还支持<code>onEventMainThread()</code>、<code>onEventBackgroundThread()</code>、<code>onEventAsync()</code>这三个方法的回调。<br />
一直到最后，我们看到这个方法把所有的方法名集合作为value，类名作为key存入了 methodCache 这个全局静态变量中。意味着，整个库在运行期间所有遍历的方法都会存在这个 map 中，而不必每次都去做耗时的反射取方法了。</p>

<div class="highlight"><pre><code class="java"> 
<span class="kd">synchronized</span> <span class="o">(</span><span class="n">methodCache</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">methodCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">subscriberMethods</span><span class="o">);</span>
<span class="o">}</span>
<span class="k">return</span> <span class="n">subscriberMethods</span><span class="o">;</span>
</code></pre></div>

<p>看了这么久，我们再回到 <code>EventBus#register()</code> 方法。这回可以看懂了，就是拿到指定类名的全部订阅方法(以 onEvent 开头的方法)，并对每一个方法调用<code>subscribe()</code>。那么再看<code>subscribe()</code>方法。  </p>

<h2 id="subscribe-1">事件的处理与发送subscribe()</h2>
<p>subscribe()方法接受四个参数，分别为：订阅者封装的对象、响应方法名封装的对象、是否为粘滞事件(可理解为广播)、这条事件的优先级。   </p>

<div class="highlight"><pre><code class="java"> 
<span class="c1">//根据传入的响应方法名获取到响应事件(参数类型)</span>
<span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">eventType</span> <span class="o">=</span> <span class="n">subscriberMethod</span><span class="o">.</span><span class="na">eventType</span><span class="o">;</span>
<span class="n">Subscription</span> <span class="n">newSubscription</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Subscription</span><span class="o">(</span><span class="n">subscriber</span><span class="o">,</span> <span class="n">subscriberMethod</span><span class="o">,</span> <span class="n">priority</span><span class="o">);</span>
<span class="c1">//通过响应事件作为key,并取得这个事件类型将会响应的全部订阅者</span>
<span class="c1">//没个订阅者至少会订阅一个事件,多个订阅者可能订阅同一个事件(多对多)</span>
<span class="c1">//key:订阅的事件,value:订阅这个事件的所有订阅者集合</span>
<span class="n">CopyOnWriteArrayList</span><span class="o">&lt;</span><span class="n">Subscription</span><span class="o">&gt;</span> <span class="n">subscriptions</span> <span class="o">=</span> <span class="n">subscriptionsByEventType</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">eventType</span><span class="o">);</span>

<span class="c1">//根据优先级插入到订阅者集合中</span>
<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">subscriptions</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">size</span> <span class="o">||</span> <span class="n">newSubscription</span><span class="o">.</span><span class="na">priority</span> <span class="o">&gt;</span> <span class="n">subscriptions</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">priority</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">subscriptions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">newSubscription</span><span class="o">);</span>
        <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">//当前订阅者订阅了哪些事件</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">subscribedEvents</span> <span class="o">=</span> <span class="n">typesBySubscriber</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">subscriber</span><span class="o">);</span>
<span class="k">if</span> <span class="o">(</span><span class="n">subscribedEvents</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">subscribedEvents</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;();</span>
    <span class="n">typesBySubscriber</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">subscriber</span><span class="o">,</span> <span class="n">subscribedEvents</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//key:订阅者对象,value:这个订阅者订阅的事件集合</span>
<span class="n">subscribedEvents</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">eventType</span><span class="o">);</span>
</code></pre></div>

<p>跳过一些初始化的局部变量(逻辑看注释就够了)<br />
如果传入的事件是有优先级之分的，则会根据优先级，将事件插入所有订阅了事件<code>eventType</code>的类的集合<code>subscriptions</code>中去。看逻辑我们发现，这里并没有对优先级的大小做限制，默认的优先级是0，priority越大，优先级越高。<br />
每个订阅者是可以有多个重载的<code>onEvent()</code>方法的，所以这里多做了一步，将所有订阅者的响应方法保存到<code>subscribedEvents</code>中。<br />
至此，我们就知道了 EventBus 中那几个map的全部含义。同时也回答了上一篇中问的为什么如果EventBus.defaultInstance不为null以后程序要抛出异常，就是因为这几个 map 不同了。 map 变了以后，订阅的事件就全部变为另一个 EventBus 对象的了，就没办法响应之前那个 EventBus 对象的订阅方法了。</p>

<p>最后又是一个感叹：子事件也可以让响应父事件的 onEvent() 。这个有点绕，举个例子，订阅者的onEvent(CharSequence),如果传一个String类型的值进去，默认情况下是不会响应的，但如果我们在构建的时候设置了 <code>eventInheritance</code> 为 true ,那么它就会响应了。  </p>

<div class="highlight"><pre><code class="java"> 
<span class="k">if</span><span class="o">(</span><span class="n">sticky</span><span class="o">)</span>
<span class="k">if</span> <span class="o">(</span><span class="n">eventInheritance</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Set</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Object</span><span class="o">&gt;&gt;</span> <span class="n">entries</span> <span class="o">=</span> <span class="n">stickyEvents</span><span class="o">.</span><span class="na">entrySet</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">entries</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">candidateEventType</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
        <span class="c1">//如果eventtype是candidateEventType同一个类或是其子类</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">eventType</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">candidateEventType</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">Object</span> <span class="n">stickyEvent</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
            <span class="n">checkPostStickyEventToSubscription</span><span class="o">(</span><span class="n">newSubscription</span><span class="o">,</span> <span class="n">stickyEvent</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">Object</span> <span class="n">stickyEvent</span> <span class="o">=</span> <span class="n">stickyEvents</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">eventType</span><span class="o">);</span>
    <span class="n">checkPostStickyEventToSubscription</span><span class="o">(</span><span class="n">newSubscription</span><span class="o">,</span> <span class="n">stickyEvent</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>

<p>最后是调用<code>checkPostStickyEventToSubscription()</code>做一次安全判断，就调用<code>postToSubscription()</code>发送事件了。<br />
这里就关联到了我们之前讲的Poster类的作用了。<br />
回答之前的问题：Poster只负责粘滞事件的代码。这里可以回答一部分：如果不是 sticky 事件都直接不执行了，还怎么响应。</p>

<div class="highlight"><pre><code class="java"> 
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">postToSubscription</span><span class="o">(...)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">threadMode</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nl">PostThread:</span>
            <span class="c1">//直接调用响应方法</span>
            <span class="n">invokeSubscriber</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">MainThread:</span>
            <span class="c1">//如果是主线程则直接调用响应事件,否则使用handle去在主线程响应事件</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">isMainThread</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">invokeSubscriber</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">mainThreadPoster</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">subscription</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>
            <span class="c1">//。。。</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<p>最后，还记得我们之前没有讲的那个<code>invokeSubscriber(subscription, event);</code>方法吗？
之前我们不知道<code>subscriberMethod</code>是什么，现在我们能看懂了，就是通过反射调用订阅者类<code>subscriber</code>的订阅方法<code>onEventXXX()</code>，并将<code>event</code>作为参数传递进去</p>

<div class="highlight"><pre><code class="java"> 
<span class="n">subscription</span><span class="o">.</span><span class="na">subscriberMethod</span><span class="o">.</span><span class="na">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">subscription</span><span class="o">.</span><span class="na">subscriber</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
</code></pre></div>

<h2 id="registerposter">Register与Poster工作图</h2>

<h4 id="section">原理图</h4>
<p><img src="/images/blog_image/20151211_6.png" alt="开源实验室：图6" /></p>

<h4 id="section-1">流程图</h4>
<p>完整的注册流程<br />
<img src="/images/blog_image/20151211_7.png" alt="开源实验室：图7" /></p>

<p>至此，整个EventBus从注册订阅到事件的处理到响应的过程我们都分析完了，最后就只剩下发送流程和取消注册了。   </p>

<p>第三篇【EventBus源码研读(下)】已更新：<a href="http://www.kymjs.com/code/2015/12/16/01/">http://kymjs.com/code/2015/12/16/01/</a>  </p>

        <br>
        <div class="support-author">
          <p>如果觉得我的文章对您有用，请随意打赏。您的支持将鼓励我继续创作！</p>
            <a href="/donate"><button class="btn btn-sm btn-primary js-toggler-target" title="Follow kymjs">¥ 打赏支持</button> </a>
        </div>

        <div align="center"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
          <ins class="adsbygoogle"
               style="display:block"
               data-ad-client="ca-pub-4706145830093249"
               data-ad-slot="1547827239"
               data-ad-format="auto"></ins>
          <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>

      </article>
      <hr>
    </div>
    <div class="post-area post comment">
      <!-- 多说评论框 start -->
      
      <div class="ds-thread" data-thread-key="/code/2015/12/13/01" data-title="EventBus源码研读(中)" data-image="http://www.kymjs.com/image/logo_s.jpg" data-url="http://www.kymjs.com/code/2015/12/13/01"></div>
      
      <!-- 多说评论框 end -->
    </div>
  </div>

  <div id="content" class="col-sm-3">
    <div id="myAffix" class="shadow-bottom-center hidden-xs" >
      <div class="categories-list-header" align="center">
        支持我请点击右上角的
        <a href="https://github.com/kymjs"><button class="btn btn-sm btn-primary js-toggler-target" title="Follow kymjs">Follow</button> </a>
      </div>
    <!--  <div class="content-text"></div> -->
    </div>

    <p>
      
    </p>

    <div id="myAffix" class="shadow-bottom-center hidden-xs" >

      <div class="categories-list-header" align="center">
        <a href="https://github.com/kymjs/kymjs.github.io/blob/master/_posts/2015-12-13-01.md"> - -> <font color="#FF0000">文章纠错</font> <- - </a>
      </div>
      
    <!--
    <div class="categories-list-header" align="center">
        Android 的 MVP 架构
        <a href="https://github.com/kymjs/TheMVP"><button class="btn btn-sm btn-primary js-toggler-target" title="Star TheMVP">Star</button> </a>
      </div>
    -->
    </div>

    <p>
      
    </p>
    <div class="shadow-corner-curl hidden-xs">
  <br />
  <ul class="list-unstyled">
      <a href="http://www.kymjs.com/about"><img src="http://www.kymjs.com/images/kymjs_round.png" alt="kymjs张涛" style="width:80%">
      </a>
  </ul>

  <span><a href="http://www.kymjs.com/about">
  <center><font color="#000000">kymjs张涛</font></center>
  </a></span><br>

  <ul class="list-unstyled">
    &nbsp;&nbsp;&nbsp;&nbsp;Android移动开发工程师，《<a href="https://github.com/kymjs/KJFrameForAndroid">KJFrameForAndroid</a>》开发框架作者。爱看书，爱敲码，善于交流，乐于分享。曾担任电影《<a href="http://baike.baidu.com/view/8784406.htm">天籁：一万年以后</a>》新媒体产品经理。

    <hr width="90%" style="border:1px dashed black; height:1px">

    <a href="http://www.kymjs.com/"></a><font color="red"><b>QQ交流群：</b></font>
    <p><a href="http://www.kymjs.com/" target="_blank"></a><a href="http://jq.qq.com/?_wv=1027&amp;k=UH2fnF" target="_blank"><font color="blue"><b>257053751</b></font>（1群，2000人）</a></p>
    <p><a href="http://jq.qq.com/?_wv=1027&amp;k=P9EObD" target="_blank"><font color="blue"><b>201055521</b></font>（2群，1000人）</a></p>
    <font color="red"><b>我的邮箱：</b></font><br>
    <p><b>kymjs123@gmail.com</b></p>
    <br />
  </ul>
  <br />
</div>
 
    <p>
      
    </p>
    <div class="shadow-corner-curl hidden-xs">
    <div class="categories-list-header" align="center">
    	本周热门
    </div>

	<ul class="list-unstyled">
		<br />
		<li><a href="/column/resourcecode.html"><font color="#EE0000">【精】</font>EventBus 源码研读系列</a></li>  
		<li><a href="/code/2015/10/18/01/">支持 gif 的图片预览控件</a></li>
		<li><a href="/code/2015/06/06/01/">Android 流式布局实现</a></li>
		<li><a href="/code/2015/11/09/01/"><font color="#EE0000">【精】</font>用 MVP 架构开发 Android 应用</a></li>
		<li><a href="/code/2015/05/26/01/">Android 夜间模式实现</a></li>
		<li><a href="/stickies/2015/04/27/01/">我的创业方案——都市书吧</a></li>
		<li><a href="/code/2015/04/01/01/"><font color="#EE0000">【精】</font>致那些正在迷茫期的开发者</a></li>	
		<br />
	</ul>
</div>

    <p>

    </p>
    <div class="shadow-corner-curl hidden-xs">
	<div class="categories-list-header" align="center">
        新浪微博
    </div> 
	<iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=1&speed=0&skin=5&isTitle=0&noborder=1&isWeibo=1&isFans=1&uid=3025443500&verifier=c1f8031e&colors=f6f6fc,f6f6fc,666666,0082cb,ecfbfd&dpc=1"></iframe>
 </div>   
    <p>

    </p>
    <div class="shadow-corner-curl hidden-xs">
    <div class="categories-list-header" align="center">
      为你推荐
    </div>   

    <ul class="list-unstyled">
      <br />
      <div align="center">
        <li><a href="https://github.com/kymjs?tab=repositories">我的GitHub</a></li> 
        <li><a href="/works">开源实验室</a></li>
        <li><a href="http://p.codekk.com/">CodeKK</a></li>
        <li><a href="http://www.androidweekly.cn/">Android开发技术周报</a></li>
        <li><a href="http://androiddevtools.cn/">AndroidDevTools</a></li>
      </div>
      <br />
    </ul>
</div>
  
  </div>
</div>
  </div>
    
    <div id="top" data-toggle="tooltip" data-placement="left" title="回到顶部">
      <a href="javascript:;">
        <div class="arrow"></div>
        <div class="stick"></div>
      </a>
    </div>

    <footer class="navbar navbar-inverse">
  <div class="container">
    <div class="row">
      <div class="col-md-12 navbar-text">
        <span> kymjs张涛的开源实验室 </span>
        <span class="point"> · </span>
        <a href="mailto:kymjs123@gmail.com"><span class="glyphicon glyphicon-envelope"></span> kymjs123@gmail.com</a>
        <span class="point"> · </span>
        
          
          <a href="https://github.com/kymjs">
            <span class="icon">
              <svg viewBox="0 0 16 16">
                <path fill="#aaa" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            Github
            <!-- <span>kymjs</span> -->
          </a>
          
          
          <span class="point"> · </span>
          <span><a href="//feed.xml">RSS</a></span>
          <span class="point"> · </span>
          <span>站务联系：766136833</span>
          <span class="point"> · </span>
          <span>Powered by Jekyll</span>

      </div>
    </div>
  </div>
</footer>

    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
      var duoshuoQuery = {short_name:"kymjs"};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//www.kymjs.com/assets/js/embed_ua.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
    </script>
    <!-- 多说公共JS代码 end -->

<!-- 在新窗口中打开 -->
  <script type="text/javascript">
    function addBlankTargetForLinks () {
      $('a[href^="http"]').each(function(){
          $(this).attr('target', '_blank');
      });
    }
    //每次在有DOM插入时触发
    $(document).bind('DOMNodeInserted', function(event) {
      addBlankTargetForLinks();
    });
  </script>
  </body>
</html>
